
name: ci
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - name: Install
        run: |
          python -m pip install -U pip
          pip install -e ".[dev]"
      - name: Lint
        run: |
          flake8
          isort --check-only .
          black --check .
      - name: Unit/Offline tests
        run: pytest -q -m "unit or offline"


cloud-gcp:
  runs-on: ubuntu-latest
  continue-on-error: true
  if: github.event_name != 'pull_request' && (secrets.GCP_PROJECT != '' || vars.GCP_PROJECT != '')
  timeout-minutes: 10
  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with: { python-version: '3.11' }
    - name: Install
      run: |
        python -m pip install -U pip
        pip install -e ".[gcp]"
    - name: ADC auth
      if: env.GOOGLE_CREDENTIALS_JSON != ''
      run: |
        echo "$GOOGLE_CREDENTIALS_JSON" > $HOME/gcp.json
        echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcp.json" >> $GITHUB_ENV
      env:
        GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
    - name: GCP smoke
      env:
        RUN_GCP_SMOKE: "true"
        GCP_PROJECT: ${{ secrets.GCP_PROJECT || vars.GCP_PROJECT }}
        VERTEX_LOCATION: ${{ secrets.VERTEX_LOCATION || vars.VERTEX_LOCATION }}
        VERTEX_CHAT_MODEL: ${{ secrets.VERTEX_CHAT_MODEL || vars.VERTEX_CHAT_MODEL }}
      run: pytest -q -m cloud tests/cloud/test_gcp_vertex_smoke.py

cloud-aws:
  runs-on: ubuntu-latest
  continue-on-error: true
  if: github.event_name != 'pull_request' && (secrets.AWS_REGION != '' || vars.AWS_REGION != '')
  timeout-minutes: 10
  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with: { python-version: '3.11' }
    - name: Install
      run: |
        python -m pip install -U pip
        pip install -e ".[aws]"
    - name: AWS smoke
      env:
        RUN_AWS_SMOKE: "true"
        AWS_REGION: ${{ secrets.AWS_REGION || vars.AWS_REGION }}
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        BEDROCK_MODEL: ${{ secrets.BEDROCK_MODEL || vars.BEDROCK_MODEL }}
      run: pytest -q -m cloud tests/cloud/test_aws_bedrock_smoke.py

cloud-azure:
  runs-on: ubuntu-latest
  continue-on-error: true
  if: github.event_name != 'pull_request' && (secrets.AZURE_OPENAI_ENDPOINT != '' || vars.AZURE_OPENAI_ENDPOINT != '')
  timeout-minutes: 10
  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with: { python-version: '3.11' }
    - name: Install
      run: |
        python -m pip install -U pip
        pip install -e ".[azure]"
    - name: Azure smoke
      env:
        RUN_AZURE_SMOKE: "true"
        AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT || vars.AZURE_OPENAI_ENDPOINT }}
        AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
        AZURE_OPENAI_DEPLOYMENT: ${{ secrets.AZURE_OPENAI_DEPLOYMENT || vars.AZURE_OPENAI_DEPLOYMENT }}
        AZURE_OPENAI_API_VERSION: ${{ secrets.AZURE_OPENAI_API_VERSION || vars.AZURE_OPENAI_API_VERSION }}
      run: pytest -q -m cloud tests/cloud/test_azure_openai_smoke.py

vector-smokes:
  runs-on: ubuntu-latest
  continue-on-error: true
  if: github.event_name != 'pull_request'
  timeout-minutes: 10
  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with: { python-version: '3.11' }
    - name: Install providers
      run: |
        python -m pip install -U pip
        pip install -e ".[providers]"
    - name: Azure AI Search smoke
      env:
        RUN_AZURE_SEARCH_SMOKE: "true"
        AZURE_SEARCH_ENDPOINT: ${{ secrets.AZURE_SEARCH_ENDPOINT || vars.AZURE_SEARCH_ENDPOINT }}
        AZURE_SEARCH_INDEX: ${{ secrets.AZURE_SEARCH_INDEX || vars.AZURE_SEARCH_INDEX }}
      run: pytest -q -m cloud tests/cloud/test_vector_backends_smoke.py::test_azure_ai_search_smoke || true
    - name: OpenSearch smoke
      env:
        RUN_OPENSEARCH_SMOKE: "true"
        OPENSEARCH_HOST: ${{ secrets.OPENSEARCH_HOST || vars.OPENSEARCH_HOST }}
        OPENSEARCH_INDEX: ${{ secrets.OPENSEARCH_INDEX || vars.OPENSEARCH_INDEX }}
      run: pytest -q -m cloud tests/cloud/test_vector_backends_smoke.py::test_opensearch_smoke || true
    - name: Matching Engine smoke
      env:
        RUN_ME_SMOKE: "true"
        GCP_PROJECT: ${{ secrets.GCP_PROJECT || vars.GCP_PROJECT }}
        ME_INDEX_ID: ${{ secrets.ME_INDEX_ID || vars.ME_INDEX_ID }}
        ME_ENDPOINT_ID: ${{ secrets.ME_ENDPOINT_ID || vars.ME_ENDPOINT_ID }}
        ME_LOCATION: ${{ secrets.VERTEX_LOCATION || vars.VERTEX_LOCATION }}
      run: pytest -q -m cloud tests/cloud/test_vector_backends_smoke.py::test_matching_engine_smoke || true
